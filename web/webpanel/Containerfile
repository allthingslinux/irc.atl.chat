# UnrealIRCd WebPanel - Official Approach (Exact Copy)
# Based on: https://github.com/unrealircd/unrealircd-webpanel/blob/main/Dockerfile

FROM composer/composer AS builder

WORKDIR /app

# Clone the webpanel source (since we don't have local source)
RUN git clone --depth 1 https://github.com/unrealircd/unrealircd-webpanel.git .

RUN composer install --no-dev --optimize-autoloader

FROM trafex/php-nginx

USER root

RUN apk add --no-cache php84-sodium

USER nobody

# Set working directory
WORKDIR /var/www/html

# Copy application files from the builder stage
COPY --from=builder /app /var/www/html

# Fix permissions for webpanel to write config files
USER root
RUN chown -R nobody:nobody /var/www/html && \
    chmod -R 755 /var/www/html/data /var/www/html/config /var/www/html/logs

USER nobody