# ================================================================================
# Atheme Services - IRC Services Daemon
# ================================================================================
FROM alpine:3.20 AS builder

# Build dependencies - minimal set for Atheme with SASL SCRAM-SHA support

# hadolint ignore=DL3018
RUN apk add --no-cache \
    build-base \
    pkgconf \
    openssl-dev \
    libidn-dev \
    git \
    autoconf \
    automake \
    libtool \
    gettext-dev

# Download and build Atheme
ARG ATHEME_VERSION="master"
WORKDIR /usr/src

# Checkout from Git with proper submodule handling
RUN git clone https://github.com/atheme/atheme -b "${ATHEME_VERSION}" --depth=1 atheme-src --recursive
WORKDIR /usr/src/atheme-src/libmowgli-2
RUN git pull origin master

# Alpine build fixes
RUN sed -i "s/@MKDIR_P@/mkdir -p/g" /usr/src/atheme-src/modules/contrib/buildsys.mk.in

# Configure with minimal options for your configuration
WORKDIR /usr/src/atheme-src
RUN ./configure \
    --prefix=/usr/local/atheme \
    --enable-contrib \
    --with-modulesdir=/usr/local/atheme/modules \
    --with-libidn \
    --enable-large-net \
    --disable-linker-defs && \
    make -j"$(nproc)" && \
    make install

# ================================================================================
# Runtime stage
# ================================================================================
FROM alpine:3.20

# Runtime dependencies - minimal set for Atheme operation
# Only include what's actually needed for the configured modules

# hadolint ignore=DL3018
RUN apk add --no-cache \
    openssl \
    libidn \
    ca-certificates \
    tini

# Runtime arguments
ARG UID=1000
ARG GID=1000

# Create atheme user and group
RUN addgroup -g ${GID} -S atheme && \
    adduser -u ${UID} -D -S -G atheme atheme

# Copy from builder
COPY --from=builder /usr/local/atheme /usr/local/atheme

# Create directory structure with proper permissions
RUN mkdir -p /usr/local/atheme/etc /usr/local/atheme/data /usr/local/atheme/logs /usr/local/atheme/logs/atheme /usr/local/atheme/var && \
    chown -R atheme:atheme /usr/local/atheme

# Copy entrypoint
COPY --chown=root:root docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Security: Don't run as root
USER atheme

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD pgrep -f atheme-services > /dev/null || exit 1

# Use tini as init system
ENTRYPOINT ["/sbin/tini", "--", "/usr/local/bin/docker-entrypoint.sh"]
